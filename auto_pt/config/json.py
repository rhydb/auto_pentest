# Author: Rhydian Brown
from .reader import ConfigReader
import json
from pathlib import Path
import auto_pt.core.modules

class JSONConfigReader(ConfigReader):
    def __init__(self, path: Path):
        super().__init__(path)

        with self.path.open(encoding="UTF-8") as f:
            self.config = json.load(f)

    def get_modules(self, config_modules):
        if isinstance(config_modules, list):
            modules = []
            for module in config_modules:
                short_name = module.get("name")
                if not short_name:
                    continue
                # rebuild the full module path
                full_path = Path("modules", short_name + ".py")
                module_class, short_name = auto_pt.core.modules.load_module(full_path)
                loaded_module = module_class()

                # load the options into the module
                options = module["options"]
                for name, value in options.items():
                    if name == "modules":
                        loaded_module.modules += self.get_modules(value)
                    else:
                        try:
                            loaded_module.options[name].set(value)
                        except ValueError as e:
                            print(f"Error setting option {name} for module {short_name}:", e)
                            exit(1)

                modules.append((loaded_module, short_name))
            return modules

        else:
            print("unsupported json config")
            exit(1)

    def get_option(self, key):
        return self.config.get(key)

    def set_option(self, key, value) -> None:
        self.config[key] = value

    def write(self):
        with self.path.open("w", encoding="UTF-8") as f:
            json.dump(self.config, f)
