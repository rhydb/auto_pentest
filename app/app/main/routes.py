# Author: Rhydian Brown
from flask import render_template, request, session
from . import main
from .. import db
import auto_pt.core.modules
import random
import string


modules = []
for m in auto_pt.core.modules.find_modules():
    mod, name = auto_pt.core.modules.load_module(m) 
    modules.append((mod(), auto_pt.core.modules.module_path(name)))

config_formats = ["YAML", "JSON"]

def generate_id():
    return ''.join(random.choices(string.ascii_letters + string.digits, k=6))

@main.post("/module/<path:subpath>")
@main.post("/module")
def add_module(subpath=""):
    parts = subpath.split("/")
    print(f"{parts=}")
    data = request.form.get("module", "")
    for mod, name in modules:
        if str(name) == data:
            id = generate_id()
            if not session.get("config"):
                session["config"] = {}

            session["config"][id] = str(name)
            session.modified = True
            parts.append(id)
            new_subpath = '/'.join(parts)
            return render_template("module.html",
                                   subpath=new_subpath,
                                   short_name=str(name),
                                   module=mod,
                                   id=id,
                                   modules=modules) + \
                    render_template("add_module_form.html", subpath=subpath, modules=modules)
    return render_template("add_module_form.html", error="Unknown module", modules=modules)

@main.route("/")
def index():
    session.setdefault("config", {})
    config = {}
    for id, name in session["config"].items():
        for mod, mod_name in modules:
            if name == str(mod_name):
                config[id] = (mod, str(mod_name))
    print(f"{config=} {session['config']=}")
    return render_template("index.html", modules=modules,
                           config_formats=config_formats,
                           config=config)
